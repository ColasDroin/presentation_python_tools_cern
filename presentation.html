<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>
      Python tools for the development, submission to clusters, and analysis of
      Dynamic Aperture studies
    </title>

    <meta
      name="description"
      content="Python tools for the development, submission to clusters, and analysis of Dynamic Aperture studies"
    />
    <meta name="author" content="Colas Droin" />

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="dist/reset.css" />
    <link rel="stylesheet" href="dist/reveal.css" />
    <link rel="stylesheet" href="dist/theme/moon.css" id="theme" />

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css" />
  </head>

  <body>
    <div class="reveal">
      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
        <section>
          <a href="https://revealjs.com">
            <img
              src="assets/logo_cern.svg"
              alt="reveal.js logo"
              style="
                height: 180px;
                margin: 0 auto 4rem auto;
                background: transparent;
              "
              class="demo-logo"
            />
          </a>
          <h6>
            Python tools for <span style="color: #00a5a5">D</span>ynamic
            <span style="color: #00a5a5">A</span>perture studies
          </h6>
          <p>
            <small>COLAS DROIN</small>
            <small> - 08.11.2024</small>
          </p>
        </section>

        <section data-markdown data-background="#eeeeee">
          <script type="text/template">
            ### Introduction
          </script>
        </section>

        <section data-markdown>
          <script type="text/template">
            ### <span style="color: #00a5a5">What</span> is a DA study?

            <small>

              Dynamic Aperture studies are used to <span style="color: #00a5a5;">optimize the beam lifetime</span> all along an accelerator cycle.

            <img src="assets/scenario.png" alt="scenario" width="600"/>

            It is known that parameters such as the tune, chromaticity, octupole intensities and
            many others can have a significant impact on the beam lifetime.

            </small>
          </script>
        </section>

        <section data-markdown>
          <script type="text/template">
            #### <span style="color: #00a5a5">DA</span> is a good proxy for <span style="color: #00a5a5">beam lifetime</span>

            <small>

              It has been shown in 2019, in MD studies, that the DA correlates with the beam lifetime.

            <img src="assets/correlation.png" alt="scenario" width="400"/>
            <img src="assets/correlation_2.png" alt="scenario" width="400"/>

            Therefore, the DA can be used to maximize the beam lifetime by optimizing the machine parameters.

            </small>
          </script>
        </section>

        <section data-markdown>
          <script type="text/template">
            ### <span style="color: #00a5a5">How</span> is the DA computed?

            <small>

            Several formulas are available to compute the DA (<span style="color: orange;">all debatable...</span>).

            We usually consider the <span style="color: #00a5a5">minimum DA</span>, i.e. the minimal amplitude of particles lost after tracking a sample distribution for a given number of turns.

            <img src="assets/DA_def.png" alt="DA-def" width="300"/>

            In practice, we consider <span style="color: #00a5a5">1280 particles</span> initially distributed according to <span style="color: #00a5a5">5 regular angles on the positive quadrant</span>, uniformly radially distributed, and we track them for <span style="color: #00a5a5">1M turns</span>.
            </small>
          </script>
        </section>

        <section data-markdown>
          <script type="text/template">
            ### How do we <span style="color: #00a5a5">optimize</span> the DA?

            <small>

            Short answer: <span style="color: orange;">brute force</span>.

            <img src="assets/oct_scan_cropped.png" alt="tune-scan" width="400"/>

            Very unelegant... but usual optimization algorithms are not efficient for this problem, since computing the DA gradient is expensive and it's easier to massively parallelize.

            </small>
          </script>
        </section>
        <section data-markdown>
          <script type="text/template">
            ### How do we <span style="color: #00a5a5">optimize</span> the DA?

            <small>

            But <span style="color: green;">not a lost cause</span>. Probably the computational load could be reduced by a large factor using some smart DA precursors.

            <span style="color: #00a5a5">Other consideration</span>: physicists like to have the full picture of the DA landscape, reducing the interest for optimizing the parameter space exploration.

            &nbsp;
            And finally, we already decrease (a bit) the computational load by:
            - trying to minize the size of the regions to scan (e.g. half tune scan)
            - adapting the range of amplitude we track (<span style="color: orange">tricky</span>)

            </small>
          </script>
        </section>

        <section data-markdown>
          <script type="text/template">
            ### <span style="color: #00a5a5">Why</span>  are tools needed for the DA?

            <small>

            Many plots like this one must be produced regularly, sometimes with hard deadlines:

            <img src="assets/tune_scan.png" alt="tune-scan" width="200"/>

            ... But history has shown that problems almost always arise:

            - <span style="color: orange">problem</span> with the Mad-X optics
            - <span style="color: orange">problem</span> with the parametrization of the scan
            - <span style="color: orange">problem</span> with the study code
            - <span style="color: orange">problem</span> with Python dependencies or Xsuite upgrade
            - <span style="color: orange">problem</span> with HTCondor
            - <span style="color: orange">problem</span> with the postprocessing
            - <span style="color: orange">problem</span> with the plotting

            </small>
          </script>
        </section>

        <section data-markdown>
          <script type="text/template">
            ### <span style="color: #00a5a5">Why</span> are tools needed for the DA?

            <small>

            <img src="assets/tune_scan.png" alt="tune-scan" width="300"/>

            Yet the scan itself can take <span style="color: orange">a couple of days to run</span> (sometimes more), and problems often reveal themselves afterwards... Meaning that one has to start all over again.

            To anticipate and avoid these stressful situations, we need to have a <span style="color: #00a5a5">robust</span> and <span style="color: #00a5a5">reproducible</span> workflow.

            In addition, not much documentation available for the uninitiated... and I'm leaving soon.

            </small>
          </script>
        </section>

        <section data-markdown>
          <script type="text/template">
            ### <span style="color: #00a5a5">What</span> was available so far

            <small>

            For the past 2 years, to ease the process of DA studies, I have adapted some legacy code to develop and maintain [template DA studies](https://github.com/xsuite/DA_study_template), available on the Xsuite repository.

            These templates have been very useful so far, and are stable, but they are not perfect, as:

            - they are <span style="color: orange">hard to maintain</span>, since we have one template for each LHC version, with a lot of code redundancy across templates.
            - they are <span style="color: orange">not so user-friendly</span>, since they must be modified extensively when doing a new study.
            - they incoporate <span style="color: orange">redundancies in the parameter declaration</span>, leading to potential inconsistencies.
            - they are <span style="color: orange">hard to adapt</span> for multigenerational scans (I'll come back to this).
            - they are <span style="color: orange">tedious to work with</span> since several separate scripts must be run in a specific order, updating each of them manually.
            - they are <span style="color: orange">not easily adaptable to build, configure and track a single collider</span>. Only scans.
            - they are <span style="color: orange">not standardized</span> (open scripts), leading to inconsistencies propagating across the different scripts.
            - they are <span style="color: orange">not so easy to setup</span> (not pip-installable) since they are open scripts.

            </small>
          </script>
        </section>

        <section data-markdown>
          <script type="text/template">
            ### <span style="color: #00a5a5">What</span> was available so far

            <small>

            Other issues (which I could have solved with the templates but did not because of time):
            - templates <span style="color: orange">do not incorporate tools for plotting</span>.
            - templates have sometimes <span style="color: orange">unexpected compatibility issues with Xsuite</span> (or other dependencies), since no Continuous Integration (CI) pipeline is set up.

            &nbsp;

            The package that I'm going to present today, [study-DA](https://colasdroin.github.io/study-DA/index.html), aims at solving all these issues.

            - It is <span style="color: #00a5a5">more user-friendly</span> and <span style="color: #00a5a5">easily flexible</span> while being more standardized.
            - It will also be <span style="color: #00a5a5">more robust</span>, since it will be tested with a CI pipeline.
            - It is more <span style="color: #00a5a5">easily maintainable</span>, since all the common code is now centralized in a given set of classes and functions.
            - It <span style="color: #00a5a5">doesn't change the philosophy of the previous templates</span>, and can be thought of an additional meta-layer to the templates to ease the overall workflow.

            </small>
          </script>
        </section>

        <section data-markdown data-background="#eeeeee">
          <script type="text/template">
            ### Introducing <span style="color: #00a5a5">study-DA</span>
          </script>
        </section>

        <section data-markdown>
          <script type="text/template">
            ### What is <span style="color: #00a5a5">study-DA</span>

            <small>

              study-DA comprises everything needed to do a full DA study, through 4 main classes:

              - <span style="color: #00a5a5">Generation</span>: Provides functions to generate, from template scripts and a configuration file, the dynamics aperture study as a multi-generational tree representing the various layers of the corresponding parametric scan.

              - <span style="color: #00a5a5">Submission</span>: Allows seamless submission of the generated study locally and/or to computing clusters (mainly HTCondor), and the automatic retrieval of the results.

              - <span style="color: #00a5a5">Postprocessing</span>: Provides functions to postprocess the raw results (usually `.parquet` files from tracking) and aggregate them into a Pandas `DataFrame`.

              - <span style="color: #00a5a5">Plotting</span>: Provides functions to visualize the postprocessed results as 2D and 3D heatmaps.

              It also includes template scripts for "usual" DA studies, configurations files for HL-LHC v1.6 and v1.3, and run III (including ions).

              Finally, it includes code for building and configuring a collider, and tracking particles.

            </small>
          </script>
        </section>

        <section data-markdown>
          <script type="text/template">
            ### Understanding the workflow

            <small>
            The workflow of study DA is usually the following:

            1. Create/adapt a <span style="color: #00a5a5">configuration file for the parameters</span> of your study (optics, knobs, etc.).

            2. Create your studies as a <span style="color: #00a5a5">set of Python scripts</span>: A, B, C... such that B depends on the output of A, C depends on the output of B (and potentially C), etc. All of these scripts use the <span style="color: #00a5a5">same configuration file</span>.

            3. Create a <span style="color: #00a5a5">configuration file for the scan</span> for the parameters, for each script (i.e. generation).

            4. <span style="color: #00a5a5">Generate your study as a tree</span>, scanning the adequate parameters at each generation, and using the corresponding scripts.

            5. <span style="color: #00a5a5">Submit</span> your scripts as jobs (locally or to the cluster).

            6. <span style="color: #00a5a5">Aggregate the results</span> of the scripts.

            7. Do the analysis and <span style="color: #00a5a5">plot</span>.

            Let's consider practical examples to better understand.
            
            </small>
          </script>
        </section>

        <section data-markdown data-background="#eeeeee">
          <script type="text/template">
            ### A small <span style="color: #00a5a5">tutorial</span>
          </script>
        </section>

        <section data-markdown data-auto-animate>
          <script type="text/template">
            ### Tutorial: <span style="color: #00a5a5">generation</span>

            <small>
              
              Configuration file for the study parameters:

              <pre style="width: 100%;"
              data-id="code-animation"
            ><code class="hljs yaml" data-trim style="max-height: 38vh;"><script type="text/template">
            
            a_random_nest:
              x: -1
            y: -2
            another_random_nest:
              and_another:
                z: -3
  
            </script></code></pre>

            </small>
          </script>
        </section>


        <section data-markdown data-auto-animate>
          <script type="text/template">
            ### Tutorial: <span style="color: #00a5a5">generation</span>

            <small>
              
              Script for generation 1:

              <pre style="width: 100%;"
              data-id="code-animation"
            ><code class="hljs python" data-trim data-line-numbers="|23-27|33-34|44-55" style="max-height: 38vh;"><script type="text/template">

              # ==================================================================================================
              # --- Imports
              # ==================================================================================================
              
              # Import standard library modules
              import logging
              import os
              
              # Import third-party modules
              # Import user-defined modules
              from study_da.utils import (
                  load_dic_from_path,
                  set_item_in_dic,
                  write_dic_to_path,
              )
              
              # Set up the logger here if needed
              
              
              # ==================================================================================================
              # --- Script functions
              # ==================================================================================================
              def add(configuration):
                  x = float(configuration["a_random_nest"]["x"])
                  z = float(configuration["another_random_nest"]["and_another"]["z"])
                  configuration["result"] = {"x_plus_z": x + z}
                  return configuration
              
              
              # ==================================================================================================
              # --- Parameters definition
              # ==================================================================================================
              dict_mutated_parameters = {{parameters}}
              path_configuration = "{{main_configuration}}"
              
              # ==================================================================================================
              # --- Script for execution
              # ==================================================================================================
              
              if __name__ == "__main__":
                  logging.info("Starting custom script")
              
                  # Load full configuration
                  full_configuration, ryaml = load_dic_from_path(path_configuration)
              
                  # Mutate parameters in configuration
                  for key, value in dict_mutated_parameters.items():
                      set_item_in_dic(full_configuration, key, value)
              
                  # Add x and z and write to configuration
                  full_configuration = add(full_configuration)
              
                  # Dump configuration
                  name_configuration = os.path.basename(path_configuration)
                  write_dic_to_path(full_configuration, name_configuration, ryaml)
              
                  logging.info("Script finished")
            </script></code></pre>

            </small>
          </script>
        </section>

        <section data-markdown data-auto-animate>
          <script type="text/template">
            ### Tutorial: <span style="color: #00a5a5">generation</span>

            <small>
              
              Script for generation 2:

              <pre style="width: 100%;"
              data-id="code-animation"
            ><code class="hljs python" data-trim data-line-numbers="|23-29|35-36|45-57" style="max-height: 38vh;"><script type="text/template">

              # ==================================================================================================
              # --- Imports
              # ==================================================================================================
              
              # Import standard library modules
              import logging
              import os
              
              # Import third-party modules
              # Import user-defined modules
              from study_da.utils import (
                  load_dic_from_path,
                  set_item_in_dic,
                  write_dic_to_path,
              )
              
              # Set up the logger here if needed
              
              
              # ==================================================================================================
              # --- Script functions
              # ==================================================================================================
              def multiply_and_dump(configuration):
                  y = float(configuration["y"])
                  x_plus_z = float(configuration["result"]["x_plus_z"])
              
                  # Dump result to txt file
                  with open("result.txt", "w") as f:
                      f.write(str(x_plus_z * y))
              
              
              # ==================================================================================================
              # --- Parameters definition
              # ==================================================================================================
              dict_mutated_parameters = {{parameters}}
              path_configuration = "{{main_configuration}}"
              
              # ==================================================================================================
              # --- Script for execution
              # ==================================================================================================
              
              if __name__ == "__main__":
                  logging.info("Starting custom script")
              
                  # Load full configuration
                  full_configuration, ryaml = load_dic_from_path(path_configuration)
              
                  # Mutate parameters in configuration
                  for key, value in dict_mutated_parameters.items():
                      set_item_in_dic(full_configuration, key, value)
              
                  # Add x and z and write to configuration
                  multiply_and_dump(full_configuration)
              
                  # Dump configuration
                  name_configuration = os.path.basename(path_configuration)
                  write_dic_to_path(full_configuration, name_configuration, ryaml)
              
                  logging.info("Script finished")
            </script></code></pre>

            </small>
          </script>
        </section>


        <section data-markdown data-auto-animate>
          <script type="text/template">
            ### Tutorial: <span style="color: #00a5a5">generation</span>

            <small>
              
              Configuration file for the scan:

              <pre style="width: 100%;"
              data-id="code-animation"
            ><code class="hljs yaml" data-trim style="max-height: 38vh;"><script type="text/template">
            


              name: example_dummy

              # List all useful files that will be used by executable in generations below
              # These files are placed at the root of the study
              dependencies:
                main_configuration: custom_files/config_dummy.yaml
              
              structure:
                # First generation is always at the root of the study
                # such that config_dummy.yaml is accessible as ../config_dummy.yaml
                generation_1:
                  executable: custom_files/generation_1_dummy.py
                  scans:
                    x:
                      # Values taken by x using a list
                      list: [1, 2]
              
                # Second generation depends on the config from the first generation
                generation_2:
                  executable: custom_files/generation_2_dummy.py
                  scans:
                    y:
                      # Values taken by y using a linspace
                      linspace: [1, 100, 3]

            </script></code></pre>

            </small>
          </script>
        </section>


        <section data-markdown data-auto-animate>
          <script type="text/template">
            ### Tutorial: <span style="color: #00a5a5">generation</span>

            <small>
              
              You can now generate the study with a one-liner (almost):

              <pre style="width: 100%;"
              data-id="code-animation"
            ><code class="hljs python" data-trim style="max-height: 38vh;"><script type="text/template">

              from study_da import create
              create(path_config_scan="config_scan.yaml")

            </script></code></pre>


            </small>

          </script>
        </section>

        <section data-markdown data-auto-animate>
          <script type="text/template">
            ### Tutorial: <span style="color: #00a5a5">generation</span>

            <small>
              
              If you check the folder in which you ran the command, you should see the following:

              <pre style="width: 100%;"
              data-id="code-animation"
            ><code class="hljs bash" data-trim style="max-height: 38vh;"><script type="text/template">

              📁 example_dummy/
              ├─╴📁 x_1/
              │   ├── 📁 y_1.0/
              │   ├── 📁 y_50.5/
              │   ├── 📁 y_100.0/
              │   │   └── 📄 generation_2.py
              │   └── 📄 generation_1.py
              ├─╴📁 x_2/
              ├─ 📄 tree.yaml
              └─ 📄 config_dummy.yaml

            </script></code></pre>
          </small>

        </script>
      </section>

        <section data-markdown data-auto-animate>
              <script type="text/template">
                ### Tutorial: <span style="color: #00a5a5">generation</span>
    
                <small>
                  
                  Which is basically what is contained in the tree file:
    
                  <pre style="width: 100%;"
                  data-id="code-animation"
                ><code class="hljs yaml" data-trim style="max-height: 38vh;"><script type="text/template">
    
                  x_1:
                  generation_1:
                    file: example_dummy/x_1/generation_1.py
                  y_1.0:
                    generation_2:
                      file: example_dummy/x_1/y_1.0/generation_2.py
                  y_50.5:
                    generation_2:
                      file: example_dummy/x_1/y_50.5/generation_2.py
                  y_100.0:
                    generation_2:
                      file: example_dummy/x_1/y_100.0/generation_2.py
                x_2:
                  generation_1:
                    file: example_dummy/x_2/generation_1.py
                  y_1.0:
                    generation_2:
                      file: example_dummy/x_2/y_1.0/generation_2.py
                  y_50.5:
                    generation_2:
                      file: example_dummy/x_2/y_50.5/generation_2.py
                  y_100.0:
                    generation_2:
                      file: example_dummy/x_2/y_100.0/generation_2.py
                
    
                </script></code></pre>
            </small>
          </script>
        </section>

        <section data-markdown data-auto-animate>
          <script type="text/template">
            ### Tutorial: <span style="color: #00a5a5">generation</span>

            <small>
              
              And if we now look at the content of the example_dummy/x_1/generation_1.py file:

              <pre style="width: 100%;"
              data-id="code-animation"
            ><code class="hljs python" data-trim data-line-numbers="|33-36|" style="max-height: 38vh;"><script type="text/template">

              # ==================================================================================================
              # --- Imports
              # ==================================================================================================
              
              # Import standard library modules
              import logging
              import os
              
              # Import third-party modules
              # Import user-defined modules
              from study_da.utils import (
                  load_dic_from_path,
                  set_item_in_dic,
                  write_dic_to_path,
              )
              
              # Set up the logger here if needed
              
              
              # ==================================================================================================
              # --- Script functions
              # ==================================================================================================
              def add(configuration):
                  x = float(configuration["a_random_nest"]["x"])
                  z = float(configuration["another_random_nest"]["and_another"]["z"])
                  configuration["result"] = {"x_plus_z": x + z}
                  return configuration
              
              
              # ==================================================================================================
              # --- Parameters definition
              # ==================================================================================================
              dict_mutated_parameters = {
                  "x": 1,
              }
              path_configuration = "../config_dummy.yaml"
              
              # ==================================================================================================
              # --- Script for execution
              # ==================================================================================================
              
              if __name__ == "__main__":
                  logging.info("Starting custom script")
              
                  # Load full configuration
                  full_configuration, ryaml = load_dic_from_path(path_configuration)
              
                  # Mutate parameters in configuration
                  for key, value in dict_mutated_parameters.items():
                      set_item_in_dic(full_configuration, key, value)
              
                  # Add x and z and write to configuration
                  full_configuration = add(full_configuration)
              
                  # Dump configuration
                  name_configuration = os.path.basename(path_configuration)
                  write_dic_to_path(full_configuration, name_configuration, ryaml)
              
                  logging.info("Script finished")
              
            </script></code></pre>

            </small>
          </script>
        </section>


        <section data-markdown data-auto-animate>
          <script type="text/template">
            ### Tutorial: <span style="color: #00a5a5">submission</span>

            <small>
              
              Let's now complete our generating script to include the submission:

              <pre style="width: 100%;"
              data-id="code-animation"
            ><code class="hljs python" data-trim style="max-height: 38vh;"><script type="text/template">

              from study_da import create, submit
              path_tree, main_configuration_file = create(path_config_scan="config_scan.yaml", force_overwrite=False)
              submit(
                  path_tree=path_tree,
                  path_python_environment="/afs/cern.ch/work/u/user/private/study-DA/.venv",
                  name_config=main_configuration_file,
                  keep_submit_until_done=True,
                  wait_time=0.1,
              )

            </script></code></pre>


            </small>

          </script>
        </section>

        <section data-markdown data-auto-animate>
          <script type="text/template">
            ### Tutorial: <span style="color: #00a5a5">submission</span>

            <small>
              
              If we run this script, we should see the following:

              <pre style="width: 100%;"
              data-id="code-animation"
            ><code class="hljs bash" data-trim style="max-height: 38vh;"><script type="text/template">

              State of the jobs:
              ********************************
              Generation 1
              Jobs left to submit later: 0
              Jobs running or queuing: 0
              Jobs submitted now: 2
              Jobs finished: 0
              Jobs failed: 0
              Jobs on hold due to failed dependencies: 0
              ********************************
              ********************************
              Generation 2
              Jobs left to submit later: 6
              Jobs running or queuing: 0
              Jobs submitted now: 0
              Jobs finished: 0
              Jobs failed: 0
              Jobs on hold due to failed dependencies: 0
              ********************************

            </script></code></pre>


            </small>

          </script>
        </section>

        <section data-markdown data-auto-animate>
          <script type="text/template">
            ### Tutorial: <span style="color: #00a5a5">submission</span>

            <small>
              
              Behind the hood, study-DA has been launching this type of run files:

              <pre style="width: 100%;"
              data-id="code-animation"
            ><code class="hljs bash" data-trim style="max-height: 38vh;"><script type="text/template">

              #!/bin/bash
              # Load the environment
              source /afs/cern.ch/work/c/cdroin/private/study-DA/.venv/bin/activate
              
              # Move into the job folder
              cd /afs/cern.ch/work/c/cdroin/.../example_dummy/x_1
              
              # Run the job and tag
              python generation_1.py > output_python.txt 2> error_python.txt
              
              # Ensure job run was successful and tag as finished, or as failed otherwise
              if [ $? -eq 0 ]; then
                  touch /afs/cern.ch/work/c/cdroin/.../example_dummy/x_1/.finished
              else
                  touch /afs/cern.ch/work/c/cdroin/.../example_dummy/x_1/.failed
              fi
              
              # Store abs path as a variable in case it's needed for additional commands
              path_job=$(pwd)
              # Optional user defined command to run

            </script></code></pre>
            </small>
          </script>
        </section>

        <section data-markdown data-auto-animate>
          <script type="text/template">
            ### Tutorial: <span style="color: #00a5a5">generation</span>

            <small>
              
              If we now recheck the tree, we should see that the jobs are fully configured and have started running:

              <pre style="width: 100%;"
              data-id="code-animation"
            ><code class="hljs yaml" data-trim style="max-height: 38vh;"><script type="text/template">

              x_1:
              generation_1:
                file: example_dummy/x_1/generation_1.py
                context: cpu
                submission_type: local
                htc_flavor: espresso
                status: finished
                path_run: 
                  /afs/cern.ch/work/c/cdroin/private/study-DA/examples/in_docs/dummy_custom_template/example_dummy/x_1/run.sh
              y_1.0:
                generation_2:
                  file: example_dummy/x_1/y_1.0/generation_2.py
                  context: cpu
                  submission_type: local
                  htc_flavor: espresso
                  status: to_submit
                  path_run: 
                    /afs/cern.ch/work/c/cdroin/private/study-DA/examples/in_docs/dummy_custom_template/example_dummy/x_1/y_1.0/run.sh
              y_50.5:
                generation_2:
                  file: example_dummy/x_1/y_50.5/generation_2.py
                  context: cpu
                  submission_type: local
                  htc_flavor: espresso
                  status: to_submit
                  path_run: 
                    /afs/cern.ch/work/c/cdroin/private/study-DA/examples/in_docs/dummy_custom_template/example_dummy/x_1/y_50.5/run.sh
              y_100.0:
                generation_2:
                  file: example_dummy/x_1/y_100.0/generation_2.py
                  context: cpu
                  submission_type: local
                  htc_flavor: espresso
                  status: to_submit
                  path_run: 
                    /afs/cern.ch/work/c/cdroin/private/study-DA/examples/in_docs/dummy_custom_template/example_dummy/x_1/y_100.0/run.sh
            x_2:
              generation_1:
                file: example_dummy/x_2/generation_1.py
                context: cpu
                submission_type: local
                htc_flavor: espresso
                status: finished
                path_run: 
                  /afs/cern.ch/work/c/cdroin/private/study-DA/examples/in_docs/dummy_custom_template/example_dummy/x_2/run.sh
              y_1.0:
                generation_2:
                  file: example_dummy/x_2/y_1.0/generation_2.py
                  context: cpu
                  submission_type: local
                  htc_flavor: espresso
                  status: to_submit
                  path_run: 
                    /afs/cern.ch/work/c/cdroin/private/study-DA/examples/in_docs/dummy_custom_template/example_dummy/x_2/y_1.0/run.sh
              y_50.5:
                generation_2:
                  file: example_dummy/x_2/y_50.5/generation_2.py
                  context: cpu
                  submission_type: local
                  htc_flavor: espresso
                  status: to_submit
                  path_run: 
                    /afs/cern.ch/work/c/cdroin/private/study-DA/examples/in_docs/dummy_custom_template/example_dummy/x_2/y_50.5/run.sh
              y_100.0:
                generation_2:
                  file: example_dummy/x_2/y_100.0/generation_2.py
                  context: cpu
                  submission_type: local
                  htc_flavor: espresso
                  status: to_submit
                  path_run: 
                    /afs/cern.ch/work/c/cdroin/private/study-DA/examples/in_docs/dummy_custom_template/example_dummy/x_2/y_100.0/run.sh
            python_environment: 
              /afs/cern.ch/work/c/cdroin/private/study-DA/examples/in_docs/dummy_custom_template/bin/activate
            absolute_path: 
              /afs/cern.ch/work/c/cdroin/private/study-DA/examples/in_docs/dummy_custom_template
            status: to_finish
            configured: true
            
            </script></code></pre>
        </small>
      </script>
    </section>


    <section data-markdown data-auto-animate>
      <script type="text/template">
        ### Tutorial: <span style="color: #00a5a5">submission</span>

        <small>
          
          Let's now try to do the same submission with Docker on HTCondor (preconfiguring to gain time):

          <pre style="width: 100%;"
          data-id="code-animation"
        ><code class="hljs python" data-trim style="max-height: 38vh;"><script type="text/template">

          from study_da import create, submit

          # Generate the study in the local directory
          path_tree, main_configuration_file = create(
              path_config_scan="config_scan.yaml", force_overwrite=False
          )
          
          path_python_environment_container = "/usr/local/DA_study/miniforge_docker"
          path_container_image = (
              "/cvmfs/unpacked.cern.ch/gitlab-registry.cern.ch/cdroin/da-study-docker:0b46f2bb"
          )
          
          # Dic copy_back_per_gen (only for HTC)
          dic_copy_back_per_gen = {
              2: {"txt": True},
          }
          
          # Preconfigure submission to HTC
          dic_config_jobs = {
              "generation_1" + ".py": {
                  "context": "cpu",
                  "submission_type": "htc_docker",
                  "htc_flavor": "espresso",
              },
              "generation_2" + ".py": {
                  "context": "cpu",
                  "submission_type": "htc_docker",
                  "htc_flavor": "espresso",
              },
          }
          
          # Submit the study
          submit(
              path_tree=path_tree,
              name_config=main_configuration_file,
              path_python_environment_container=path_python_environment_container,
              path_container_image=path_container_image,
              dic_copy_back_per_gen=dic_copy_back_per_gen,
              dic_config_jobs=dic_config_jobs,
              keep_submit_until_done=True,
              wait_time=2,
          )

        </script></code></pre>
        </small>
      </script>
    </section>

    <section data-markdown data-auto-animate>
      <script type="text/template">
        ### Tutorial: <span style="color: #00a5a5">submission</span>

        <small>
          
          Basically everything is the same as before, except that the generated run file is a bit more complicated:

          <pre style="width: 100%;"
          data-id="code-animation"
        ><code class="hljs bash" data-trim style="max-height: 38vh;"><script type="text/template">

          #!/bin/bash
          # Load the environment
          source /usr/local/DA_study/miniforge_docker/bin/activate
          
          # Copy config in (what will be) the level above
          cp -f /afs/cern.ch/work/c/cdroin/...example_dummy/x_2/y_1.0/../config_dummy.yaml .
          
          # Create local directory on node and cd into it
          mkdir y_1.0
          cd y_1.0
          
          # Mutate the paths in config to be absolute
          
          # Run the job and tag
          python /afs/cern.ch/work/c/cdroin/.../example_dummy/x_2/y_1.0/generation_2.py > output_python.txt 2> error_python.txt
          
          
          # Ensure job run was successful and tag as finished, or as failed otherwise
          if [ $? -eq 0 ]; then
              touch /afs/cern.ch/work/c/cdroin/.../example_dummy/x_2/y_1.0/.finished
          else
              touch /afs/cern.ch/work/c/cdroin/.../example_dummy/x_2/y_1.0/.failed
          fi
          
          # Delete the config file from the above directory, otherwise it will be copied back and overwrite the new config
          rm ../config_dummy.yaml
          # Copy back output, including the new config
          cp -f *.parquet *.yaml *.txt /afs/cern.ch/work/c/cdroin/.../example_dummy/x_2/y_1.0
          
          # Store abs path as a variable in case it's needed for additional commands
          path_job=/afs/cern.ch/work/c/cdroin/.../example_dummy/x_2/y_1.0
          
          # Optional user defined command to run

        </script></code></pre>
        </small>
      </script>
    </section>


    <section data-markdown data-background="#eeeeee">
      <script type="text/template">
        ### A practical <span style="color: #00a5a5">example</span> of DA study
      </script>
    </section>


        <section style="text-align: left" data-markdown>
          <script type="text/template">
            # THANK YOU

            <span style="color: #00a5a5">Questions?</span> <span style="color: white">Suggestions?</span> <span style="color: green">Comments?</span>
          </script>
        </section>
      </div>
    </div>

    <script src="dist/reveal.js"></script>
    <script src="plugin/zoom/zoom.js"></script>
    <script src="plugin/notes/notes.js"></script>
    <script src="plugin/search/search.js"></script>
    <script src="plugin/markdown/markdown.js"></script>
    <script src="plugin/highlight/highlight.js"></script>
    <script>
      // Also available as an ES module, see:
      // https://revealjs.com/initialization/
      Reveal.initialize({
        controls: true,
        progress: true,
        center: true,
        hash: true,
        slideNumber: true,
        margin: 0.04,
        width: 1100,
        height: 700,

        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [
          RevealZoom,
          RevealNotes,
          RevealSearch,
          RevealMarkdown,
          RevealHighlight,
        ],
      });
    </script>
  </body>
</html>
